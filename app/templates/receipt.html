<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const tg = Telegram.WebApp;
  tg.ready(); // сообщаем Telegram, что UI готов

  function extractGroupId() {
    try {
      const p = tg?.initDataUnsafe?.start_param;
      if (typeof p === 'string' && p.startsWith('group_')) return p.slice('group_'.length);
      const qs = new URLSearchParams(location.search);
      if (qs.has('group_id')) return qs.get('group_id');
    } catch {}
    return null;
  }

  async function getPositions() {
    if (Array.isArray(window.POSITIONS) && window.POSITIONS.length) return window.POSITIONS;
    const groupId = extractGroupId();
    if (!groupId) return [];
    const r = await fetch(`/webapp/api/positions?group_id=${encodeURIComponent(groupId)}`);
    return r.ok ? await r.json() : [];
  }

  function updateSummary(selectedQuantities, positions, summaryEl) {
    let total = 0, count = 0;
    for (const idx of Object.keys(selectedQuantities)) {
      const q = +selectedQuantities[idx] || 0;
      if (q > 0) {
        const p = positions[idx];
        total += q * (+p.price || 0);
        count += q;
      }
    }
    summaryEl.textContent = count === 0 ? 'Ничего не выбрано'
      : `Выбрано ${count} на сумму ${total.toFixed(2)}₽`;
  }

  (async function init() {
    const positions = await getPositions();
    const listEl = document.getElementById('list');
    const summaryEl = document.getElementById('summary');
    const selectedQuantities = {};

    positions.forEach((item, idx) => {
      const el = document.createElement('div');
      el.className = 'item';
      const info = document.createElement('div');
      info.style.display='flex'; info.style.flexDirection='column'; info.style.flex='1';
      const name = document.createElement('span'); name.textContent = item.name;
      const meta = document.createElement('span'); meta.style.fontSize='14px'; meta.style.color='#666';
      meta.textContent = `${item.quantity} × ${item.price}₽`;
      info.appendChild(name); info.appendChild(meta); el.appendChild(info);

      const controls = document.createElement('div'); controls.className='controls';
      const maxQty = Math.max(0, parseInt(item.quantity) || 0) || 1;
      const minus = document.createElement('button'); minus.textContent='–';
      const input = document.createElement('input'); input.type='number'; input.min='0'; input.max=String(maxQty); input.step='1'; input.value='0';
      const plus = document.createElement('button'); plus.textContent='+';

      const apply = (val) => {
        if (val > 0) { selectedQuantities[idx] = val; el.classList.add('selected'); }
        else { delete selectedQuantities[idx]; el.classList.remove('selected'); }
        updateSummary(selectedQuantities, positions, summaryEl);
      };

      minus.onclick = (e) => { e.stopPropagation(); const v = Math.max(0, (+input.value||0)-1); input.value=String(v); apply(v); };
      plus.onclick  = (e) => { e.stopPropagation(); const v = Math.min(maxQty, (+input.value||0)+1); input.value=String(v); apply(v); };
      input.oninput = ()  => { let v = +input.value||0; v = Math.max(0, Math.min(maxQty, v)); input.value=String(v); apply(v); };
      el.onclick     = (e) => { if ([minus, plus, input].includes(e.target)) return; let v = +input.value||0; if (v<maxQty){ v++; input.value=String(v); apply(v);} };

      controls.appendChild(minus); controls.appendChild(input); controls.appendChild(plus);
      el.appendChild(controls); listEl.appendChild(el);
    });

    updateSummary(selectedQuantities, positions, summaryEl);

    document.getElementById('submit').addEventListener('click', async () => {
      const payload = {};
      for (const [idx, q] of Object.entries(selectedQuantities)) if ((+q||0) > 0) payload[idx] = +q;

      const groupId = extractGroupId();
      const data = { selected: payload };
      if (groupId) data.group_id = groupId;

      // 1) Пытаемся отослать как service-message (работает только для keyboard web_app)
      try {
        tg.sendData(JSON.stringify(data));
        tg.close();
        return;
      } catch (_) {}

      // 2) Fallback: отправка напрямую на backend (deep-link, группы)
      try {
        await fetch('/webapp/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...data, init_data: tg.initData })
        });
      } catch (_) {}
      tg.close();
    });
  })();
</script>
