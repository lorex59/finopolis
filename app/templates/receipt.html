<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Разделение чека</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding: 20px;
        margin: 0;
        background-color: #f9f9fb;
        color: #202020;
      }
      h1 {
        font-size: 22px;
        margin-bottom: 16px;
        text-align: center;
        font-weight: 600;
      }
      /* Контейнер для списка позиций */
      #list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
      }
      .item:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .item.selected {
        background-color: #e6f4ff;
      }
      .item span {
        font-size: 16px;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .controls input[type=number] {
        width: 50px;
        padding: 4px;
        font-size: 14px;
      }
      .controls button {
        width: 28px;
        height: 28px;
        font-size: 16px;
        line-height: 1;
        padding: 0;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        cursor: pointer;
        border-radius: 4px;
      }
      .controls button:hover {
        background-color: #e0e0e0;
      }
      button {
        margin-top: 20px;
        width: 100%;
        padding: 12px 0;
        font-size: 16px;
        font-weight: 500;
        background-color: #2ea44f;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      button:hover {
        background-color: #24963f;
      }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <h1>Выберите позиции, которые вы покупали</h1>
    <div id="list"></div>
    <!-- Блок с итоговой информацией о выборе -->
    <div id="summary" style="margin-top: 12px; font-weight: bold; text-align: center;"></div>
      <button id="submit">Отправить</button>
    <script>
      /*
       * Мини‑приложение для выбора позиций
       *
       * Список позиций передаётся сервером через глобальную переменную window.POSITIONS.
       * Пользователь может выбрать несколько элементов, по каждому из которых
       * автоматически подсчитывается стоимость (количество × цена). Внизу
       * отображается суммарная стоимость выбранных позиций и их количество.
       */
      const positions = window.POSITIONS || [];
      const listEl = document.getElementById('list');
      const summaryEl = document.getElementById('summary');
      // Храним выбранное количество по индексу позиции. По умолчанию пусто.
      const selectedQuantities = {};
      /**
       * Пересчитывает количество и сумму выбранных позиций.
       */
      function updateSummary() {
        let total = 0;
        let count = 0;
        Object.keys(selectedQuantities).forEach((idx) => {
          const qtySelected = parseFloat(selectedQuantities[idx]) || 0;
          if (qtySelected > 0) {
            const p = positions[idx];
            const price = parseFloat(p.price) || 0;
            total += qtySelected * price;
            count += qtySelected;
          }
        });
        // Формируем красивую строку с количеством и суммой
        summaryEl.textContent = count === 0
          ? 'Ничего не выбрано'
          : `Выбрано ${count} ${count === 1 ? 'позиция' : (count < 5 ? 'позиции' : 'позиций')} на сумму ${total.toFixed(2)}₽`;
      }
      // Создаём элементы списка. Для каждой позиции выводим название, исходное количество,
      // цену и поле ввода количества, которое пользователь хочет выбрать.
      positions.forEach((item, idx) => {
        const el = document.createElement('div');
        el.className = 'item';
        // Левая часть: название + исходное количество и цена
        const infoContainer = document.createElement('div');
        infoContainer.style.display = 'flex';
        infoContainer.style.flexDirection = 'column';
        infoContainer.style.flex = '1';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = item.name;
        const qtyPriceSpan = document.createElement('span');
        qtyPriceSpan.style.fontSize = '14px';
        qtyPriceSpan.style.color = '#666';
        qtyPriceSpan.textContent = `${item.quantity} × ${item.price}₽`;
        infoContainer.appendChild(nameSpan);
        infoContainer.appendChild(qtyPriceSpan);
        el.appendChild(infoContainer);
        // Правая часть: число (0..item.quantity) и кнопки +/-. Также поддерживаем ввод вручную.
        const controls = document.createElement('div');
        controls.className = 'controls';
        const maxQty = parseFloat(item.quantity) || 1;
        // Кнопка минус
        const minusBtn = document.createElement('button');
        minusBtn.type = 'button';
        minusBtn.textContent = '–';
        // Поле ввода
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.max = String(maxQty);
        input.step = '1';
        input.value = '0';
        // Кнопка плюс
        const plusBtn = document.createElement('button');
        plusBtn.type = 'button';
        plusBtn.textContent = '+';
        // Функция обновления выбранного количества и подсветки
        function updateSelection(val) {
          if (val > 0) {
            selectedQuantities[idx] = val;
            el.classList.add('selected');
          } else {
            delete selectedQuantities[idx];
            el.classList.remove('selected');
          }
        }
        // Обработчики кнопок
        minusBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          let val = parseInt(input.value) || 0;
          if (val > 0) {
            val--;
            input.value = String(val);
            updateSelection(val);
            updateSummary();
          }
        });
        plusBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          let val = parseInt(input.value) || 0;
          if (val < maxQty) {
            val++;
            input.value = String(val);
            updateSelection(val);
            updateSummary();
          }
        });
        // Обработчик изменения вручную
        input.addEventListener('input', () => {
          let val = parseInt(input.value) || 0;
          if (val < 0) val = 0;
          if (val > maxQty) val = maxQty;
          input.value = String(val);
          updateSelection(val);
          updateSummary();
        });
        // Клик по всей строке увеличивает количество на 1 (если не клик по элементам управления)
        el.addEventListener('click', (ev) => {
          if (ev.target === minusBtn || ev.target === plusBtn || ev.target === input) {
            return;
          }
          let val = parseInt(input.value) || 0;
          if (val < maxQty) {
            val++;
            input.value = String(val);
            updateSelection(val);
            updateSummary();
          }
        });
        controls.appendChild(minusBtn);
        controls.appendChild(input);
        controls.appendChild(plusBtn);
        el.appendChild(controls);
        listEl.appendChild(el);
      });
      // Инициализируем отображение
      updateSummary();
      // ----------------------------------------------------------------------
      // При отправке формируем объект, где key — индекс позиции, value — выбранное количество.
      // Дополнительно передаём идентификатор группы (group_id), чтобы бот мог
      // сопоставить выбор пользователя с нужным чатом. В зависимости от того,
      // как было открыто мини‑приложение, group_id можно получить либо из
      // параметров URL (?group_id=...), либо из Telegram.WebApp.initDataUnsafe.start_param.
      document.getElementById('submit').addEventListener('click', () => {
        const payload = {};
        Object.keys(selectedQuantities).forEach((idx) => {
          const qty = parseFloat(selectedQuantities[idx]) || 0;
          if (qty > 0) {
            payload[idx] = qty;
          }
        });
        // Определяем group_id. Сначала пробуем параметр group_id в URL, затем
        // start_param, который передаётся через deep‑link (?startapp=group_<id>).
        let groupId = null;
        try {
          const params = new URLSearchParams(window.location.search);
          groupId = params.get('group_id');
        } catch (e) {
          groupId = null;
        }
        // Если groupId не найден в query, пытаемся разобрать start_param из initData.
        try {
          const initData = Telegram?.WebApp?.initDataUnsafe || {};
          const startParam = initData.start_param || initData.startParam;
          if (!groupId && typeof startParam === 'string' && startParam.startsWith('group_')) {
            groupId = startParam.slice('group_'.length);
          }
        } catch (e) {
          // ignore
        }
        // Формируем итоговый объект. Включаем group_id, если он найден.
        const dataToSend = { selected: payload };
        if (groupId) {
          dataToSend.group_id = groupId;
        }
        Telegram.WebApp.sendData(JSON.stringify(dataToSend));
        Telegram.WebApp.close();
      });
    </script>
  </body>
</html>